# 犬猫検出サンプルプログラム システム仕様書

## 文書情報
- **プログラム名**: camera_detection_test.py
- **バージョン**: 1.0.0
- **作成日**: 2025-07-20
- **対象**: YOLOv8を用いた犬猫検出サンプルプログラム

## 1. 概要

### 1.1 プログラム目的
Raspberry Pi カメラモジュール v3とYOLOv8深層学習モデルを使用してリアルタイムで犬と猫の検出を行うサンプルプログラムです。メインのパン・チルト追跡アプリケーション開発前に、カメラ機能とAI検出機能の動作確認を行います。

### 1.2 主要機能
- Raspberry Pi カメラからのリアルタイム映像取得
- YOLOv8モデルによる犬猫検出処理
- バウンディングボックスとラベルの可視化
- 検出パフォーマンスの監視・表示
- フレーム保存機能

### 1.3 対象ハードウェア
| コンポーネント | 型番/仕様 | 用途 |
|---|---|---|
| Raspberry Pi | Pi 5 | プログラム実行・AI推論処理 |
| カメラモジュール | Pi Camera v3 (SKU:8701) | 映像入力 |

### 1.4 技術スタック
- **AI モデル**: YOLOv8 (You Only Look Once v8)
- **画像処理**: OpenCV
- **深層学習**: Ultralytics
- **言語**: Python 3.9+

## 2. システム構成

### 2.1 ソフトウェアアーキテクチャ
```
camera_detection_test.py
├── CameraDetector クラス
│   ├── カメラ制御モジュール
│   ├── YOLOv8推論モジュール
│   ├── 描画・表示モジュール
│   ├── パフォーマンス監視モジュール
│   └── ファイル保存モジュール
├── コマンドライン引数解析
└── メイン実行制御
```

### 2.2 データフロー
```
カメラ映像取得 → YOLOv8推論 → 検出結果処理 → 描画処理 → 画面表示
       ↓              ↓             ↓
   フレーム保存    パフォーマンス測定   統計更新
```

### 2.3 依存ライブラリ
- `ultralytics`: YOLOv8モデル制御
- `opencv-python`: カメラ制御・画像処理
- `numpy`: 数値計算・配列処理

## 3. クラス仕様

### 3.1 CameraDetector クラス

#### 3.1.1 クラス概要
カメラからの映像取得、YOLOv8による物体検出、結果の可視化を一元的に管理するメインクラスです。

#### 3.1.2 クラス属性
| 属性名 | 型 | 説明 |
|---|---|---|
| `model_path` | str | YOLOv8モデルファイルパス |
| `confidence` | float | 検出信頼度閾値 (0.0-1.0) |
| `resolution` | Tuple[int, int] | カメラ解像度 (width, height) |
| `target_fps` | int | 目標フレームレート |
| `cap` | cv2.VideoCapture | OpenCVカメラオブジェクト |
| `model` | YOLO | YOLOv8モデルインスタンス |
| `DOG_CLASS_ID` | int | 犬のクラスID (16) |
| `CAT_CLASS_ID` | int | 猫のクラスID (15) |
| `colors` | dict | 描画色設定 (BGR形式) |
| `class_names` | dict | クラス名マッピング |
| `fps_counter` | int | FPS計算用フレームカウンタ |
| `current_fps` | float | 現在のFPS値 |
| `processing_times` | List[float] | 処理時間履歴 |
| `dog_count` | int | 現在フレームの犬検出数 |
| `cat_count` | int | 現在フレームの猫検出数 |

## 4. メソッド仕様

### 4.1 `__init__(self, model_path, confidence, resolution, target_fps)`
#### 目的
CameraDetectorクラスの初期化とパラメータ設定を行います。

#### 引数
- `model_path` (str): YOLOv8モデルファイルパス
- `confidence` (float): 検出信頼度閾値 (0.0-1.0)
- `resolution` (Tuple[int, int]): カメラ解像度
- `target_fps` (int): 目標フレームレート

#### 戻り値
なし

#### 処理詳細
- パラメータの設定と保存
- COCO datasetクラスIDの設定 (犬:16, 猫:15)
- 描画色の設定 (犬:青、猫:緑)
- パフォーマンス監視用変数の初期化

---

### 4.2 `initialize_camera(self) -> bool`
#### 目的
Raspberry Pi カメラモジュールの初期化と設定を行います。

#### 引数
なし

#### 戻り値
- `True`: 初期化成功
- `False`: 初期化失敗

#### 処理詳細
1. OpenCV VideoCapture(0) でカメラオープン
2. フレーム幅・高さの設定
3. FPS設定
4. 実際の設定値の確認・表示
5. 初期化状態の検証

#### エラーハンドリング
- カメラデバイス不検出時の適切なエラー処理
- 設定値適用失敗時の警告表示

---

### 4.3 `load_model(self) -> bool`
#### 目的
YOLOv8モデルの読み込みと初期化を行います。

#### 引数
なし

#### 戻り値
- `True`: 読み込み成功
- `False`: 読み込み失敗

#### 処理詳細
1. 指定パスからYOLOv8モデル読み込み
2. 初回実行時の自動ダウンロード対応
3. モデル設定情報の表示
4. 推論エンジンの準備

#### モデル対応
- **yolov8n.pt**: 軽量版 (推奨)
- **yolov8s.pt**: 小型版
- **yolov8m.pt**: 中型版
- **yolov8l.pt**: 大型版
- **yolov8x.pt**: 超大型版

---

### 4.4 `detect_pets(self, frame) -> List[dict]`
#### 目的
入力フレームに対してYOLOv8推論を実行し、犬猫の検出を行います。

#### 引数
- `frame` (np.ndarray): 入力画像フレーム

#### 戻り値
- `List[dict]`: 検出結果のリスト

#### 戻り値構造
```python
[
    {
        'class_id': int,        # クラスID (15:猫, 16:犬)
        'confidence': float,    # 信頼度 (0.0-1.0)
        'bbox': tuple,          # (x1, y1, x2, y2)
        'class_name': str       # 'Dog' または 'Cat'
    }
]
```

#### 処理詳細
1. YOLOv8モデルによる推論実行
2. 信頼度閾値による結果フィルタリング
3. 犬猫クラスのみ抽出 (class_id: 15, 16)
4. バウンディングボックス座標の取得
5. 処理時間の計測・記録

#### パフォーマンス最適化
- verbose=False で推論ログ抑制
- 処理時間履歴の管理 (最新100フレーム)

---

### 4.5 `draw_detections(self, frame, detections) -> np.ndarray`
#### 目的
検出結果をフレームに視覚的に描画します。

#### 引数
- `frame` (np.ndarray): 入力画像フレーム
- `detections` (List[dict]): 検出結果リスト

#### 戻り値
- `np.ndarray`: 描画済みフレーム

#### 描画要素
1. **バウンディングボックス**: 矩形枠 (線幅2px)
   - 犬: 青色 (255, 0, 0)
   - 猫: 緑色 (0, 255, 0)
2. **ラベル背景**: 塗りつぶし矩形
3. **ラベルテキスト**: "クラス名 信頼度" 形式
   - フォント: HERSHEY_SIMPLEX
   - サイズ: 0.6
   - 色: 白 (255, 255, 255)

#### 処理詳細
- 検出数のカウント更新
- 各検出結果の反復処理
- OpenCV描画関数による可視化

---

### 4.6 `draw_info(self, frame) -> np.ndarray`
#### 目的
フレームに各種情報表示を描画します。

#### 引数
- `frame` (np.ndarray): 入力画像フレーム

#### 戻り値
- `np.ndarray`: 情報描画済みフレーム

#### 表示情報
1. **FPS表示**: "FPS: XX.X" 形式
2. **検出数表示**: "Dogs: X, Cats: X" 形式
3. **処理時間**: "Avg Process Time: XX.Xms" 形式
4. **操作説明**: "Press 'q' or ESC to quit, 's' to save"

#### 描画位置
- FPS: 左上 (10, 30)
- 検出数: 左上 (10, 60)
- 処理時間: 左上 (10, 90)
- 操作説明: 右下角

#### スタイル設定
- フォント: HERSHEY_SIMPLEX
- 色: 黄色 (0, 255, 255) / 白色 (255, 255, 255)

---

### 4.7 `update_fps(self) -> None`
#### 目的
FPS（フレームレート）の計算と更新を行います。

#### 引数
なし

#### 戻り値
なし

#### 処理詳細
1. フレームカウンタのインクリメント
2. 1秒間隔でのFPS計算
3. カウンタと開始時間のリセット
4. 現在FPS値の更新

#### 計算式
```
FPS = フレーム数 / 経過時間
```

---

### 4.8 `save_frame(self, frame) -> None`
#### 目的
現在のフレームを画像ファイルとして保存します。

#### 引数
- `frame` (np.ndarray): 保存対象フレーム

#### 戻り値
なし

#### 処理詳細
1. 保存ディレクトリ "captured_frames" の作成
2. タイムスタンプ付きファイル名生成
3. JPEG形式での画像保存
4. 保存完了メッセージ表示

#### ファイル名形式
```
captured_frames/detection_YYYYMMDD_HHMMSS.jpg
```

#### エラーハンドリング
- ディスク容量不足時の処理
- 権限エラー時の処理

---

### 4.9 `run(self) -> None`
#### 目的
メインの実行ループを制御します。

#### 引数
なし

#### 戻り値
なし

#### 処理フロー
1. 開始メッセージと操作説明の表示
2. フレーム読み取りループ
3. 犬猫検出処理の実行
4. 結果描画と情報表示
5. ウィンドウでの映像表示
6. キー入力処理
7. FPS更新

#### キー操作
- `'q'` または `ESC`: プログラム終了
- `'s'`: 現在フレーム保存

#### 例外処理
- KeyboardInterrupt (Ctrl+C) の適切な処理
- 一般例外のキャッチと表示

---

### 4.10 `cleanup(self) -> None`
#### 目的
プログラム終了時のリソースクリーンアップを実行します。

#### 引数
なし

#### 戻り値
なし

#### 処理詳細
1. カメラリソースの解放
2. OpenCVウィンドウの閉鎖
3. 実行統計の表示
4. クリーンアップ完了通知

#### 統計情報表示
- 平均処理時間
- 最大処理時間
- 最小処理時間
- 最終FPS値

## 5. 関数仕様

### 5.1 `parse_arguments() -> argparse.Namespace`
#### 目的
コマンドライン引数の解析と検証を行います。

#### 引数
なし

#### 戻り値
- `argparse.Namespace`: 解析済み引数オブジェクト

#### 対応引数
| 引数 | 型 | デフォルト | 説明 |
|---|---|---|---|
| `--model` | str | yolov8n.pt | YOLOv8モデルパス |
| `--confidence` | float | 0.5 | 信頼度閾値 |
| `--resolution` | int × 2 | [640, 480] | カメラ解像度 |
| `--fps` | int | 30 | 目標フレームレート |

#### 使用例表示
```
python camera_detection_test.py
python camera_detection_test.py --model yolov8s.pt --confidence 0.6
python camera_detection_test.py --resolution 1280 720 --fps 24
```

---

### 5.2 `main()`
#### 目的
プログラムのメイン実行制御を行います。

#### 引数
なし

#### 戻り値
なし

#### 処理詳細
1. 開始メッセージの表示
2. コマンドライン引数の解析・検証
3. CameraDetectorインスタンス生成
4. 初期化処理 (カメラ・モデル)
5. メイン実行ループの開始

#### 引数検証
- 信頼度: 0.0-1.0範囲チェック
- 解像度: 正の整数チェック
- FPS: 正の整数チェック

## 6. データ構造

### 6.1 検出結果構造
```python
Detection = {
    'class_id': int,        # COCO dataset class ID
    'confidence': float,    # 信頼度スコア (0.0-1.0)
    'bbox': tuple,          # (x1, y1, x2, y2) 座標
    'class_name': str       # 表示用クラス名
}
```

### 6.2 色設定構造
```python
colors = {
    16: (255, 0, 0),    # 犬: 青色 (BGR)
    15: (0, 255, 0),    # 猫: 緑色 (BGR)
}
```

### 6.3 統計データ構造
```python
performance_stats = {
    'processing_times': List[float],    # 処理時間履歴
    'fps_counter': int,                 # フレームカウンタ
    'current_fps': float,               # 現在FPS
    'dog_count': int,                   # 犬検出数
    'cat_count': int                    # 猫検出数
}
```

## 7. システムインターフェース

### 7.1 ハードウェアインターフェース
#### カメラ接続
- **プロトコル**: CSI (Camera Serial Interface)
- **解像度**: 可変 (640x480〜1920x1080)
- **フレームレート**: 最大30fps
- **色空間**: BGR (Blue-Green-Red)

### 7.2 ソフトウェアインターフェース
#### 標準出力
```
犬猫検出サンプルプログラム
YOLOv8を用いたリアルタイム犬猫検出

設定パラメータ:
  モデル: yolov8n.pt
  信頼度閾値: 0.5
  解像度: 640x480
  目標FPS: 30

カメラを初期化中...
カメラ設定完了:
  解像度: 640x480
  FPS: 30.0

YOLOv8モデルを読み込み中: yolov8n.pt
モデルの読み込みが完了しました
初期化完了。検出を開始します...
```

#### ウィンドウ表示
- **ウィンドウ名**: "Pet Detection Test"
- **表示内容**: リアルタイム映像 + 検出結果
- **操作**: マウス・キーボード入力対応

#### ファイル出力
```
captured_frames/
├── detection_20250720_143022.jpg
├── detection_20250720_143045.jpg
└── detection_20250720_143112.jpg
```

## 8. パフォーマンス仕様

### 8.1 処理性能目標
| 項目 | 目標値 | 測定方法 |
|---|---|---|
| フレームレート | 20fps以上 | リアルタイム計測 |
| 検出遅延 | 50ms以下 | 処理時間測定 |
| 検出精度 | 信頼度0.5以上 | 手動評価 |
| メモリ使用量 | 1GB以下 | システム監視 |

### 8.2 推奨システム要件
| コンポーネント | 推奨仕様 |
|---|---|
| CPU | ARM Cortex-A76 × 4 (Pi 5) |
| メモリ | 4GB以上 |
| ストレージ | 8GB以上空き容量 |
| GPU | VideoCore VII (Pi 5内蔵) |

### 8.3 モデル性能比較
| モデル | サイズ | 推論速度 | 精度 | 推奨用途 |
|---|---|---|---|---|
| yolov8n.pt | 6MB | 最高速 | 標準 | リアルタイム |
| yolov8s.pt | 22MB | 高速 | 高 | バランス型 |
| yolov8m.pt | 52MB | 中速 | 高 | 高精度要求 |
| yolov8l.pt | 87MB | 低速 | 最高 | オフライン処理 |

## 9. エラーハンドリング

### 9.1 想定エラーケース
| エラー種別 | 原因 | 対応処理 |
|---|---|---|
| ImportError | ライブラリ未インストール | インストール手順表示後終了 |
| カメラ接続エラー | ハードウェア未接続 | エラーメッセージ表示後終了 |
| モデル読み込みエラー | ファイル不存在・破損 | エラーメッセージ表示後終了 |
| フレーム読み取りエラー | カメラ切断 | ループ終了・クリーンアップ |
| 推論エラー | メモリ不足・GPU問題 | エラー表示・次フレーム継続 |
| ファイル保存エラー | ディスク容量不足 | エラー表示・処理継続 |
| KeyboardInterrupt | ユーザー中断 | 安全停止・クリーンアップ |

### 9.2 復旧戦略
1. **軽微なエラー**: 警告表示・処理継続
2. **重大なエラー**: エラー表示・安全停止
3. **リソースエラー**: クリーンアップ・再試行
4. **ユーザー中断**: 即座に安全停止

## 10. セキュリティ考慮事項

### 10.1 プライバシー保護
- 保存画像の適切な管理
- 顔認識データの非保存
- 個人識別情報の収集禁止

### 10.2 リソース保護
- メモリリークの防止
- ファイルハンドルの適切な管理
- プロセス終了時の確実なクリーンアップ

## 11. テスト項目

### 11.1 機能テスト
- [ ] カメラ初期化・映像表示確認
- [ ] YOLOv8モデル読み込み確認
- [ ] 犬検出・バウンディングボックス表示確認
- [ ] 猫検出・バウンディングボックス表示確認
- [ ] 信頼度スコア表示確認
- [ ] FPS表示・更新確認
- [ ] フレーム保存機能確認
- [ ] キー操作・終了処理確認

### 11.2 パフォーマンステスト
- [ ] フレームレート測定 (20fps以上)
- [ ] 処理遅延測定 (50ms以下)
- [ ] メモリ使用量監視 (1GB以下)
- [ ] 長時間動作安定性確認 (30分以上)

### 11.3 ロバストネステスト
- [ ] カメラ切断・再接続テスト
- [ ] 異常フレーム処理テスト
- [ ] メモリ不足状況テスト
- [ ] 高負荷状況下動作テスト

### 11.4 ユーザビリティテスト
- [ ] コマンドライン引数動作確認
- [ ] エラーメッセージの分かりやすさ
- [ ] 操作説明の適切性
- [ ] 視覚的表示の見やすさ

## 12. 保守・運用

### 12.1 ログ管理
- 処理時間統計の自動記録
- エラー発生状況の追跡
- パフォーマンス履歴の保持

### 12.2 設定管理
- コマンドライン引数による柔軟な設定
- モデルファイルのバージョン管理
- カメラパラメータの最適化

### 12.3 アップデート対応
- YOLOv8モデルの更新手順
- 依存ライブラリのバージョン管理
- 機能拡張時の互換性確保

---

## 改訂履歴
| バージョン | 日付 | 変更内容 | 作成者 |
|---|---|---|---|
| 1.0.0 | 2025-07-20 | 初版作成 | Claude |