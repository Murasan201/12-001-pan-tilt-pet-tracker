### 文書番号: 12-001

## 1. アプリ名
- アプリ名: パン・チルトAI追跡カメラアプリ（ペット見守り）

## 2. 概要
Adafruit社製サーボドライバ（2327）とRaspberry Piカメラモジュールv3、およびSG90搭載パン・チルトマウントを用いて、YOLOv8モデルで犬および猫を検出し追跡するPythonアプリケーションです。検出なしの場合はランダムにパン・チルトを動作させ、検出時は対象が画面中心に来るよう角度を補正します。定期的にバウンディングボックス付きの静止画を撮影し、Slack Webhookで通知します。

## 3. 目的
- YOLOv8を用いたリアルタイムペット検出・追跡技術の習得
- サーボドライバによるパン・チルト制御の理解
- 検出結果の可視化とSlack連携による通知ワークフローの習得

## 4. 対象利用者
- プログラミング初心者
- Raspberry Pi入門者
- IoTデバイスを用いたペットモニタリングを学びたいユーザー

## 5. システム構成
| コンポーネント                                      | 役割                                                        |
|-----------------------------------------------------|-------------------------------------------------------------|
| Raspberry Pi 5                                      | スクリプト実行、モデル推論、サーボ制御                      |
| Adafruit 16-Channel PWM/Servo Driver (2327)         | サーボモータのPWM制御                                       |
| Raspberry Pi カメラモジュール v3                     | ビデオキャプチャ                                            |
| SG90サーボ搭載パン・チルトマウント (Switch Science) | パン・チルト機構                                            |
| Slack Webhook                                       | 定期静止画通知                                               |

## 6. ハードウェア要件
- Raspberry Pi 5本体
- microSDカード（Raspberry Pi OSインストール済み）
- Adafruit 16-Channel PWM/Servo Driver（SKU:2327）
- Raspberry Pi カメラモジュール v3（SKU:8701）
- SG90サーボ搭載パン・チルトマウント（SKU:3486）
- SG90サーボモータ ×2
- ジャンパーワイヤ、電源ケーブル
- 電源（公式5Vアダプタ）

## 7. ソフトウェア要件
- OS：Raspberry Pi OS（最新推奨）
- 言語：Python 3.9以上
- ライブラリ：
  - ultralytics（YOLOv8）
  - adafruit-circuitpython-pca9685（Servo Driver制御）
  - opencv-python（映像入力・描画）
  - requests（Slack Webhook通知）
  - python-dotenv（環境変数管理）
- その他の依存は設計者が調査・選定すること

## 8. 機能要件
1. **初期化**
   - カメラおよびサーボドライバを起動・初期化
2. **犬および猫検出**
   - 各フレームをYOLOv8モデルへ入力し、クラス `dog` および `cat` の検出結果を取得
3. **追跡／ランダム動作**
   - 検出あり: 対象のバウンディングボックス中心と画面中心の差分からパン・チルト角度を計算・補正
   - 検出なし: 一定間隔でランダムなパン・チルト角度に移動
4. **静止画キャプチャ**
   - 指定間隔でバウンディングボックスを描画したフレームをJPEGで保存
5. **Slack通知**
   - 環境変数 `SLACK_WEBHOOK_URL` で指定されたWebhookへキャプチャ画像をPOST
6. **設定パラメータ**
   - コマンドライン引数または`.env`で以下を指定可能：
     - `--interval`: 静止画キャプチャ間隔（秒）
     - `--pan-range`／`--tilt-range`: ランダム動作範囲（度）
     - `--model`: YOLOv8モデルパス

## 9. 非機能要件
- **可読性**: PEP8準拠、コメント充実
- **単一ファイル完結**: 可能な限り一つのPythonファイルで実装
- **信頼性**: 例外処理・再試行ロジックを実装
- **低遅延**: フレーム処理が1秒未満で完了する設計

## 10. テスト要件
- **検出テスト**: 犬および猫をカメラ前に置き、検出・追跡が動作するか確認
- **ランダム動作テスト**: 検出なし時に予期せぬ方向へ移動するか検証
- **キャプチャおよび通知テスト**: 指定間隔で画像保存・Slack通知が行われるか確認
- **終了処理テスト**: キー入力や停止コマンドで正常停止・リソース解放を確認

## 11. 受け入れ基準
1. 犬または猫検出時に画角が自動補正され、対象が画面中心に追従する  
2. 検出なし時にランダムパン・チルト動作が実行される  
3. 静止画キャプチャとSlack通知が指定間隔で動作する  
4. エラー時に適切なログが出力され、再試行または安全停止する  

## 12. サーボテストプログラム要件
メインプログラム開発前に、パン・チルト機構の動作確認を行うテストプログラムを作成します。

### 12.1. プログラム名
- servo_test.py

### 12.2. 目的
- Adafruit PWMサーボドライバとSG90サーボの動作確認
- パン・チルト機構の可動範囲と動作の安全性確認
- 配線およびハードウェア接続の検証

### 12.3. 機能要件
1. **初期化**
   - Adafruit PCA9685サーボドライバの初期化
   - パン・チルトサーボの中央位置への設定
2. **動作テスト**
   - パン（左右）方向: 3回往復動作
   - チルト（上下）方向: 3回往復動作
   - 各動作間に1秒のウェイト時間
3. **安全停止**
   - テスト完了後は中央位置に復帰
   - リソースの適切な解放

### 12.4. 技術仕様
- **動作範囲**: パン±90度、チルト±45度（安全範囲内）
- **PWM周波数**: 50Hz（サーボ標準）
- **パルス幅**: 1.0ms〜2.0ms（SG90標準範囲）
- **動作速度**: ゆっくりとした動作で安全性確保

### 12.5. テスト手順
1. ハードウェア接続確認
2. プログラム実行
3. パン動作の確認（左右3往復）
4. チルト動作の確認（上下3往復）
5. 中央位置復帰の確認
6. 異常音や振動がないことの確認

### 12.6. 受け入れ基準
1. サーボドライバが正常に初期化される
2. パン・チルト動作が指定回数実行される
3. 動作範囲が安全範囲内に収まる
4. テスト完了後に中央位置に復帰する
5. エラー時に適切なメッセージが表示される

---
以上の要件をもとに、サーボテストプログラムおよびパン・チルトAI追跡カメラアプリ（ペット見守り）のプロトタイプを開発してください。
